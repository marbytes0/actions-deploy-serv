name: Deploy to Cloudflare Pages

on:
  workflow_dispatch:
    inputs:
      repository_url:
        description: 'GitHub Repository URL (owner/repo format)'
        required: true
      cloudflare_api_token:
        description: 'Cloudflare API Token'
        required: true
      cloudflare_account_id:
        description: 'Cloudflare Account ID'
        required: true
      cloudflare_project_name:
        description: 'Cloudflare Pages Project Name'
        required: true
      github_token:
        description: 'GitHub Token'
        required: true
      app_id:
        description: 'App ID for callback'
        required: true
      # Custom domain inputs (uncomment when ready):
      # cloudflare_zone_id:
      #   description: 'Cloudflare Zone ID for custom domain'
      #   required: false
      #   default: ''
      # cloudflare_api_dns_token:
      #   description: 'Cloudflare API DNS Token for custom domain'
      #   required: false
      #   default: ''
      # custom_domain:
      #   description: 'Custom domain subdomain (e.g., myapp for myapp.yourdomain.com)'
      #   required: false
      #   default: ''

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.inputs.repository_url }}
          token: ${{ github.event.inputs.github_token }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Install dependencies
        run: |
          echo "Installing dependencies..."
          
          # Send progress update
          APP_URL="${{ secrets.APP_URL }}"
          if [ -z "$APP_URL" ]; then
            APP_URL="http://localhost:3000"
          fi
          
          curl -X POST "${APP_URL}/api/cloudflare-deploy-progress" \
            -H "Content-Type: application/json" \
            -d "{\"appId\":\"${{ github.event.inputs.app_id }}\",\"stage\":\"installing\",\"percentage\":30,\"message\":\"Installing dependencies...\"}" \
            || echo "Failed to send progress update (non-critical)"
          
          if [ -f "package.json" ]; then
            cat package.json
            pnpm install
          else
            echo "ERROR: package.json not found!"
            exit 1
          fi

      - name: Build project
        run: |
          echo "Building project..."
          
          # Send progress update
          APP_URL="${{ secrets.APP_URL }}"
          if [ -z "$APP_URL" ]; then
            APP_URL="http://localhost:3000"
          fi
          
          curl -X POST "${APP_URL}/api/cloudflare-deploy-progress" \
            -H "Content-Type: application/json" \
            -d "{\"appId\":\"${{ github.event.inputs.app_id }}\",\"stage\":\"building\",\"percentage\":50,\"message\":\"Building project...\"}" \
            || echo "Failed to send progress update (non-critical)"
          
          pnpm run build || {
            echo "Build failed! Checking for errors..."
            echo "Package.json scripts:"
            cat package.json | grep -A 10 "scripts"
            exit 1
          }
          echo "Build complete, checking output..."
          ls -la
          if [ -d "dist" ]; then
            echo "✓ dist folder exists"
            ls -la dist
          else
            echo "✗ dist folder not found!"
            echo "Checking for other build outputs..."
            find . -type d -name "build" -o -name "out" -o -name ".next" | head -5
            exit 1
          fi

      - name: Deploy to Cloudflare Pages
        id: deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ github.event.inputs.cloudflare_api_token }}
          CLOUDFLARE_ACCOUNT_ID: ${{ github.event.inputs.cloudflare_account_id }}
        run: |
          echo "=== STARTING CLOUDFLARE DEPLOYMENT ==="
          echo "Project name: ${{ github.event.inputs.cloudflare_project_name }}"
          echo "Account ID: ${{ github.event.inputs.cloudflare_account_id }}"
          echo "Token length: ${#CLOUDFLARE_API_TOKEN}"
          echo ""
          
          # Send progress update
          APP_URL="${{ secrets.APP_URL }}"
          if [ -z "$APP_URL" ]; then
            APP_URL="http://localhost:3000"
          fi
          
          curl -X POST "${APP_URL}/api/cloudflare-deploy-progress" \
            -H "Content-Type: application/json" \
            -d "{\"appId\":\"${{ github.event.inputs.app_id }}\",\"stage\":\"deploying\",\"percentage\":70,\"message\":\"Deploying to Cloudflare Pages...\"}" \
            || echo "Failed to send progress update (non-critical)"
          
          # Check if dist folder exists
          if [ ! -d "dist" ]; then
            echo "❌ ERROR: dist folder not found!"
            echo "Available directories:"
            ls -la
            exit 1
          fi
          
          echo "✓ Dist folder exists"
          echo "Dist folder contents:"
          ls -la dist
          echo ""
          
          # Install wrangler globally
          echo "Installing wrangler..."
          npm install -g wrangler
          echo "✓ Wrangler installed"
          
          # Check wrangler version
          echo "Wrangler version:"
          wrangler --version
          echo ""
          
          # Deploy with detailed logging
          echo "=== DEPLOYING TO CLOUDFLARE PAGES ==="
          
          # First, try to create the project (will fail if exists, but that's ok)
          echo "Creating Cloudflare Pages project..."
          wrangler pages project create "${{ github.event.inputs.cloudflare_project_name }}" --production-branch=main || echo "Project might already exist, continuing..."
          echo ""
          
          # Send progress update
          curl -X POST "${APP_URL}/api/cloudflare-deploy-progress" \
            -H "Content-Type: application/json" \
            -d "{\"appId\":\"${{ github.event.inputs.app_id }}\",\"stage\":\"deploying\",\"percentage\":85,\"message\":\"Uploading files to Cloudflare...\"}" \
            || echo "Failed to send progress update (non-critical)"
          
          # Now deploy
          echo "Deploying to Cloudflare Pages..."
          DEPLOY_START=$(date +%s)
          
          if wrangler pages deploy dist \
            --project-name="${{ github.event.inputs.cloudflare_project_name }}" \
            --branch=main \
            --commit-dirty=true; then
            
            DEPLOY_END=$(date +%s)
            DEPLOY_TIME=$((DEPLOY_END - DEPLOY_START))
            
            echo ""
            echo "=== ✅ DEPLOYMENT SUCCESSFUL ==="
            echo "Project URL: https://${{ github.event.inputs.cloudflare_project_name }}.pages.dev"
            echo "Deployment time: ${DEPLOY_TIME}s"
            
            # Send final progress update
            curl -X POST "${APP_URL}/api/cloudflare-deploy-progress" \
              -H "Content-Type: application/json" \
              -d "{\"appId\":\"${{ github.event.inputs.app_id }}\",\"stage\":\"completed\",\"percentage\":100,\"message\":\"Deployment completed successfully in ${DEPLOY_TIME}s\"}" \
              || echo "Failed to send progress update (non-critical)"
          else
            DEPLOY_EXIT_CODE=$?
            echo ""
            echo "=== ❌ DEPLOYMENT FAILED ==="
            echo "Exit code: $DEPLOY_EXIT_CODE"
            echo "Wrangler version: $(wrangler --version)"
            echo "Environment check:"
            echo "- CLOUDFLARE_API_TOKEN length: ${#CLOUDFLARE_API_TOKEN}"
            echo "- CLOUDFLARE_ACCOUNT_ID: ${CLOUDFLARE_ACCOUNT_ID}"
            echo "- Project name: ${{ github.event.inputs.cloudflare_project_name }}"
            echo ""
            echo "Common issues:"
            echo "1. Project doesn't exist - use --yes flag to auto-create"
            echo "2. Invalid API token or Account ID"
            echo "3. Project name contains invalid characters"
            
            # Send failure progress update
            curl -X POST "${APP_URL}/api/cloudflare-deploy-progress" \
              -H "Content-Type: application/json" \
              -d "{\"appId\":\"${{ github.event.inputs.app_id }}\",\"stage\":\"failed\",\"percentage\":0,\"message\":\"Deployment failed with exit code ${DEPLOY_EXIT_CODE}\",\"error\":\"Wrangler deployment failed\"}" \
              || echo "Failed to send progress update (non-critical)"
            
            exit $DEPLOY_EXIT_CODE
          fi

      - name: Verify Cloudflare deployment
        if: steps.deploy.outcome == 'success'
        env:
          CLOUDFLARE_API_TOKEN: ${{ github.event.inputs.cloudflare_api_token }}
          CLOUDFLARE_ACCOUNT_ID: ${{ github.event.inputs.cloudflare_account_id }}
        run: |
          echo "=== VERIFYING DEPLOYMENT ==="
          echo "Checking if project exists in Cloudflare Pages..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            -H "Content-Type: application/json" \
            "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/pages/projects/${{ github.event.inputs.cloudflare_project_name }}")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "✅ Project verified in Cloudflare Pages!"
            echo "$BODY" | grep -o '"url":"[^"]*"' | head -1
          else
            echo "⚠️  Warning: Could not verify project (this might be normal for first deployment)"
            echo "The project may take a few moments to appear in the API"
          fi

      - name: Send callback notification
        if: always()
        continue-on-error: true
        run: |
          APP_URL="${{ secrets.APP_URL }}"
          
          # Skip callback if no APP_URL is configured
          if [ -z "$APP_URL" ]; then
            echo "⚠️  APP_URL not configured - skipping callback"
            echo "This is normal for local development"
            echo "To enable callbacks, add APP_URL secret to your GitHub repository"
            exit 0
          fi
          
          if [ "${{ job.status }}" == "success" ] && [ "${{ steps.deploy.outcome }}" == "success" ]; then
            STATUS="completed"
            ERROR=""
          else
            STATUS="failed"
            ERROR="Deployment failed - check workflow logs"
          fi
          
          echo "=== SENDING DEPLOYMENT CALLBACK ==="
          echo "Deployment status: $STATUS"
          echo "Project URL: https://${{ github.event.inputs.cloudflare_project_name }}.pages.dev"
          echo "App URL: ${APP_URL}"
          
          # Send callback to app
          CALLBACK_RESPONSE=$(curl -X POST "${APP_URL}/api/cloudflare-deploy-callback" \
            -H "Content-Type: application/json" \
            -d "{
              \"appId\": \"${{ github.event.inputs.app_id }}\",
              \"status\": \"${STATUS}\",
              \"url\": \"https://${{ github.event.inputs.cloudflare_project_name }}.pages.dev\",
              \"projectName\": \"${{ github.event.inputs.cloudflare_project_name }}\",
              \"error\": \"${ERROR}\"
            }" \
            -w "\nHTTP_CODE:%{http_code}" \
            -s) || true
          
          HTTP_CODE=$(echo "$CALLBACK_RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          RESPONSE_BODY=$(echo "$CALLBACK_RESPONSE" | grep -v "HTTP_CODE:")
          
          echo "Callback HTTP Code: $HTTP_CODE"
          echo "Callback Response: $RESPONSE_BODY"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "✅ Callback sent successfully"
          else
            echo "⚠️  Warning: Callback failed (HTTP $HTTP_CODE)"
            echo "This is normal if app is not accessible from GitHub Actions"
          fi

      # Custom domain DNS setup (uncomment when ready):
      # - name: Setup Custom Domain DNS
      #   if: ${{ github.event.inputs.custom_domain != '' }}
      #   run: |
      #     curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ github.event.inputs.cloudflare_zone_id }}/dns_records" \
      #       -H "Authorization: Bearer ${{ github.event.inputs.cloudflare_api_dns_token }}" \
      #       -H "Content-Type: application/json" \
      #       --data '{
      #         "type": "CNAME",
      #         "name": "${{ github.event.inputs.custom_domain }}",
      #         "content": "${{ github.event.inputs.cloudflare_project_name }}.pages.dev",
      #         "ttl": 1,
      #         "proxied": true
      #       }'
